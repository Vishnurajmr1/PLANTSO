<main>
  <!--====== Section 1 ======-->
  <div class="u-s-p-y-60">

    <!--====== Section Content ======-->
    <div class="section__content">
      <div class="container">
        <div class="breadcrumb">
          <div class="breadcrumb__wrap">
            <ul class="breadcrumb__list">
              <li class="has-separator">

                <a href="/">Home</a></li>
              <li class="is-marked">

                <a href="/cart">Cart</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--====== End - Section 1 ======-->
{{#if hasProducts}}
  <!--====== Section 2 ======-->
  <div class="u-s-p-b-60">

    <!--====== Section Intro ======-->
    <div class="section__intro u-s-m-b-60">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="section__text-wrap">
              <h1 class="section__heading u-c-secondary">SHOPPING CART</h1>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--====== End - Section Intro ======-->

    <!--====== Section Content ======-->
    

    <div class="section__content">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12 u-s-m-b-30">
            <div class="table-responsive">
              <table class="table-p">
                <thead>
                  <tr>
                    <th  class="table-header">ProductDetails</th>
                    <th class="table-header">Quantity * Price</th>
                    {{!-- <th class="table-header">TotalPrice</th> --}}
                    <th class="table-header">SUBTOTAL</th>
                    <th class="table-header">Actions</th>

                    <th class="table-header">Remove</th>
                  </tr>
                </thead>
                <tbody>

                  <!--====== Row ======-->
                  {{#each products}}
                  <tr id="product-{{this.productId}}">
                    <td>
                      <div class="table-p__box">
                        <div class="table-p__img-wrap">
                        
                          <img
                            class="u-img-fluid"
                            src="images/product/electronic/product3.jpg"
                            alt=""
                          /></div>
                        <div class="table-p__info">

                          <span class="table-p__name">

                            <a href="/">{{this.product}}</a></span>

                          <span class="table-p__category">

                            <a

                              href="shop-side-version-2.html"
                              id="quantity-{{this.productId}}"
                            >Quantity:[{{this.quantity}}]</a></span>
                            <ul class="table-p__variant-list">
                            <li>

                              <span>InStock:{{this.stock}}</span></li>
                            <li> 
                              <span style="color: black;font-weight: bold;">Price: ₹{{this.price}}</span>
                             </li>
                          </ul> 
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="product-info">
                         <a
                              href="shop-side-version-2.html"
                              class="quantity-{{this.productId}}"
                            >{{this.quantity}}</a>x
                            <span class="table-p__price"  data-price="{{this.price}}">{{this.price}}</span>
                      </div>
                           </td>
                            <td>
                      <div class="product-info">
                            <span class="table-p__price" id="price-{{this.productId}}" data-price="{{this.updatedPrice}}">₹{{this.updatedPrice}}</span>
                      </div>
                           </td>
                    <td>
                      <div class="table-p__input-counter-wrap">
                        <!--====== Input Counter ======-->
                        <div class="input-counter">
                          <span
                            class="input-counter__minus fas fa-minus"
                            onclick="decrementQuantity('{{this.productId}}')"
                          ></span>
                          <input
                            class="input-counter__text input-counter--text-primary-style"
                            type="text"
                             value="{{this.quantity}}"
                            data-min="1"
                            data-max="{{this.stock}}"
                            data-stock="{{this.stock}}"
                            id="quantity-{{this.productId}}"
                            data-product-id="{{this.productId}}"
                            {{!-- onchange="CalculatePrice('{{this.productId}}')" --}}
                          />
                          <span
                            class="input-counter__plus fas fa-plus"
                            onclick="incrementQuantity('{{this.productId}}')"
                          ></span></div>
                        <!--====== End - Input Counter ======-->
                      </div>
                    </td>
                    <td>
                      <div class="table-p__del-wrap">
                        <a id="deleteButton" class="far fa-trash-alt table-p__delete-link" onclick="deleteFromCart('{{this.productId}}','{{this.product}}')"></a>
                        </div>
                        {{!-- <span class="highlight">{{this.productName}}</span> --}}
                    </td>
                  </tr>
                  {{/each}}
                  
                  <!--====== End - Row ======-->

                </tbody>
              </table>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="route-box">
              <div class="route-box__g1">

                <a class="route-box__link" href="/shop"><i
                    class="fas fa-long-arrow-alt-left"
                  ></i>

                  <span>CONTINUE SHOPPING</span></a></div>
              <div class="route-box__g2">

                <a class="route-box__link" href="cart.html"><i
                    class="fas fa-trash"
                  ></i>

                  <span>CLEAR CART</span></a>

                <a class="route-box__link" href="cart.html"><i
                    class="fas fa-sync"
                  ></i>

                  <span>UPDATE CART</span></a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--====== End - Section Content ======-->
  </div>
  <!--====== End - Section 2 ======-->

  <!--====== Section 3 ======-->
  <div class="u-s-p-b-60">

    <!--====== Section Content ======-->
    <div class="section__content">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12 u-s-m-b-30">
            <form class="f-cart">
              <div class="row">
                <div class="col-lg-4 col-md-6 u-s-m-b-30">
                  <div class="f-cart__pad-box">
                    <h1 class="gl-h1">ESTIMATE SHIPPING AND TAXES</h1>

                    <span class="gl-text u-s-m-b-30">Enter your destination to
                      get a shipping estimate.</span>
                    <div class="u-s-m-b-30">

                      <!--====== Select Box ======-->

                      <label class="gl-label" for="shipping-country">COUNTRY *</label><select
                        class="select-box select-box--primary-style"
                        id="shipping-country"
                      >
                        <option selected value="">Choose Country</option>
                        <option value="uae">United Arab Emirate (UAE)</option>
                        <option value="uk">United Kingdom (UK)</option>
                        <option value="us">United States (US)</option>
                      </select>
                      <!--====== End - Select Box ======-->
                    </div>
                    <div class="u-s-m-b-30">

                      <!--====== Select Box ======-->

                      <label
                        class="gl-label"
                        for="shipping-state"
                      >STATE/PROVINCE *</label><select
                        class="select-box select-box--primary-style"
                        id="shipping-state"
                      >
                        <option selected value="">Choose State/Province</option>
                        <option value="al">Alabama</option>
                        <option value="al">Alaska</option>
                        <option value="ny">New York</option>
                      </select>
                      <!--====== End - Select Box ======-->
                    </div>
                    <div class="u-s-m-b-30">

                      <label class="gl-label" for="shipping-zip">ZIP/POSTAL CODE
                        *</label>

                      <input
                        class="input-text input-text--primary-style"
                        type="text"
                        id="shipping-zip"
                        placeholder="Zip/Postal Code"
                      /></div>
                    <div class="u-s-m-b-30">

                      <a
                        class="f-cart__ship-link btn--e-transparent-brand-b-2"
                        href="cart.html"
                      >CALCULATE SHIPPING</a></div>

                    <span class="gl-text">Note: There are some countries where
                      free shipping is available otherwise our flat rate charges
                      or country delivery charges will be apply.</span>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 u-s-m-b-30">
                  <div class="f-cart__pad-box">
                    <h1 class="gl-h1">NOTE</h1>

                    <span class="gl-text u-s-m-b-30">Add Special Note About Your
                      Product</span>
                    <div>

                      <label for="f-cart-note"></label><textarea
                        class="text-area text-area--primary-style"
                        id="f-cart-note"
                      ></textarea></div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-6 u-s-m-b-30">
                  <div class="f-cart__pad-box">
                    <div class="u-s-m-b-30">
                      <table class="f-cart__table">
                        <tbody>
                          <tr>
                            <td>SHIPPING</td>
                            <td>$0.00</td>
                          </tr>
                          <tr>
                            <td>TAX</td>
                            <td>$0.00</td>
                          </tr>
                          <tr>
                            <td>SUBTOTAL</td>
                            <td id="subTotal">$379.00</td>
                          </tr>
                          <tr>
                            <td>GRAND TOTAL</td>
                            <td id="grandTotal">$379.00</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div>

                      <button class="btn btn--e-brand-b-2" type="submit">
                        PROCEED TO CHECKOUT</button></div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!--====== End - Section Content ======-->
  </div>
  {{else}}
   <!--======emptycart Section 1 ======-->
  <div class="u-s-p-y-60">

    <!--====== emptycartSection Content ======-->
    <div class="section__content">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 u-s-m-b-30">
            <div class="empty">
              <div class="empty__wrap">

                <span class="empty__big-text">EMPTY</span>

                <span class="empty__text-1">No items found on your cart.</span>

                <a
                  class="empty__redirect-link btn--e-brand"
                  href="/shop"
                >CONTINUE SHOPPING</a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--====== End - emptycart Section Content ======-->
  </div>
  <!--====== End - emptycart Section 1 ======-->
  {{/if}}
  <!--====== End - Section 3 ======-->

</main>
<script>
/*
document.getElementById('deleteButton').addEventListener('onclick',(e)=>{
e.preventDefault();
  console.log('hi')
  fetch('/delete_post',{
    method:'POST',
    headers:{
      'Content-Type':'application/json'
    }
  }).then((result)=>{
    res.json(success:true,message:"Product from cart deleted successfully")
  }).catch((err)=>{
    res.json(success:false,message:'Product is not deleted');
  })
}) */

function deleteFromCart(productId,productName){
  console.log(productName);
        Swal.fire({
          title:'Are you Sure?',
          html: `You are about to delete <span class="highlighted-text">${productName}</span> from your cart`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!',
          customClass:{
            title: 'custom-title-class',
            content: 'custom-content-class',
          },
        }).then((result)=>{
          if(result.isConfirmed){
            fetch('/cart-delete-item',{
          method:"POST",
          headers:{
            'Content-Type':'application/json'
          },
          body: JSON.stringify({productId}),
        }).then(async(res)=>{
        const response=await res.json();
          console.log(response);
          console.log(productId);
          if(response.success){
            Swal.fire(
        'Success',
        `<span class="highlighted-text">${productName}</span> deleted from cart successfully`,
        'success'
        )
        const deletedItem=document.getElementById(`product-${productId}`);
        console.log(deletedItem);
        if(deletedItem){
          deletedItem.remove();
        }
          }else{
            Swal.fire(
        'Error',
        'Oops!Something went wrong.Product not deleted from cart',
        'error'
      )
            console.log('Error:Product not deleted from cart');
          }
        })
        .catch((err)=>{
          console.log(err);
        });
     }
    });
        
}


const minusBtn=document.querySelectorAll(".input-counter__minus");
const plusBtn=document.querySelectorAll(".input-counter__plus");

console.log(minusBtn)
console.log(plusBtn)

minusBtn.forEach((button)=>{
  button.addEventListener('click',decrementQuantity);
})

plusBtn.forEach((button)=>{
  button.addEventListener('click',incrementQuantity);
})

//Event handler for decrementing the quantity

function decrementQuantity(productId){
  const quantityElement = document.querySelector(`input[data-product-id="${productId}"]`);
  //const quantityElement=document.querySelector(`input[data-product-id="${productId}"]`); 
  const quantity=parseInt(quantityElement.value);
  const minQunatity=parseInt(quantityElement.dataset.min);
  //const minQunatity=parseInt(quantityElement.dataset.min);
console.log(productId)
  console.log(quantityElement)
  console.log(quantity+'😂😂😂');
  console.log(minQunatity+'😂😂😂');
  if(quantity>minQunatity){
    //quantityElement.value=quantity-1;
    //const newQuantity=quantity-1;
    //quantityElement.value=newQuantity;
    //quantityElement.setAttribute('value',newQuantity);
    updateQuantitySpan(productId,quantity-1);
    //updatePriceSpan(productId,quantity-1);
    console.log(quantityElement+'‼️‼️‼️')
   //updateProductQuantity(productId,quantity);
    //calculatePrice(productId);

  }
}

function incrementQuantity(productId){
  const quantityElement = document.querySelector(`input[data-product-id="${productId}"]`);

  // const quantityElement=document.querySelector(`input[data-product-id]="${productId}"]`)
  const quantity=parseInt(quantityElement.value);
  //const maxQunatity=parseInt(quantityElement.getAttribute("max"));
  const maxQuantity = parseInt(quantityElement.dataset.max);
  if(quantity<maxQuantity){
    //quantityElement.value=quantity+1;
    // const newQuantity=quantity+1;
    //quantityElement.value=newQuantity; 
    //quantityElement.setAttribute('value',newQuantity);
    updateQuantitySpan(productId,quantity+1);
    //updatePriceSpan(productId,quantity+1);
    //calculatePrice(productId); 

  }
  console.log(productId)
  console.log(quantityElement.value)
  console.log(quantityElement)
  console.log(quantityElement.dataset)
  console.log(quantityElement.dataset.max)
  console.log(quantity+'😂😂😂');
  console.log(maxQuantity+'😂😂😂');
}


function updateQuantitySpan(productId,quantity){

  const specificLink=document.querySelector(`#quantity-${productId}`)
  specificLink.textContent=`Quantity:[${quantity}]`;
  const quantitySpans = document.querySelectorAll(`.quantity-${productId}`);
  quantitySpans.forEach((span)=>{
    if(span!==specificLink){
     span.textContent = `${quantity}`;
    }
  });
  //console.log(productId+'😂😂😂')
  //console.log(quantity+'🎭🎭🎭') 
  updateProductQuantity(productId,quantity);
  //quantityId.textContent = `Quantity:${quantity}`;
}
/*
function updatePriceSpan(productId,quantity){
  const priceSpan=document.querySelector(`#price-${productId}`);
  const price=parseFloat(priceSpan.dataset.price);
  console.log(priceSpan);
  if(!isNaN(price)){
  const newPrice=price*quantity;
  priceSpan.innerText=`₹${newPrice.toFixed(2)}`;
  console.log(newPrice);
  }else{
    // Handle the case where price is NaN
    priceSpan.innerText = 'Invalid Price';
  }
}
*/

function updateProductQuantity(productId, quantity) {
  fetch('/cart', {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      quantity: quantity,
      productId: productId,
    }),
  })
    .then(function (response) {
      if (response.ok) {
        return response.json();
      }
      throw new Error('Network response was not ok.');
    })
    .then(function (data) {
      console.log(data);

      //Update the price in the HTML based on the received data

      const priceElement=document.getElementById(`price-${productId}`);
      const subTotal=document.getElementById('subTotal');
      const grandTotal=document.getElementById('grandTotal');
      if(priceElement){
        console.log(priceElement.textContent);
        priceElement.textContent=`₹${data.updatedPrice}`;
        priceElement.dataset.price=data.updatedPrice;
        subTotal.textContent=`₹${data.cartTotal}`
        grandTotal.textContent=`₹${data.cartTotal}`
        console.log(`After update${priceElement.textContent}`);
      }
    })
    .catch(function (error) {
      console.error('There was a problem with the updating product operation:', error);
    });
}


</script>